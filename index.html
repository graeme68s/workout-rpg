<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Workout RPG</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #121212; color: #ffffff; padding: 20px; padding-bottom: 100px; overflow-x: hidden; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 15px; max-width: 400px; margin: auto; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; z-index: 10; }
        .stat-group { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .stat { text-align: center; }
        .val { display: block; font-size: 24px; font-weight: bold; color: #00ff88; }
        .item { background: #2a2a2a; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; border-left: 5px solid transparent; transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        .item.done { border-left: 5px solid #00ff88; color: #888; }
        .box { width: 20px; height: 20px; border: 2px solid #555; margin-right: 15px; border-radius: 4px; pointer-events: none; }
        .done .box { background: #00ff88; border-color: #00ff88; }
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
        #completeBtn { background: #00ff88; color: #000; }
        #addBtn { background: #333; color: #fff; margin-top: 20px; }
        .sync-btn { background: #2a2a2a; color: #888; font-size: 12px; padding: 10px; margin-top: 5px; border: 1px solid #444; }
        #alert { background: #ff3b30; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; text-align: center; font-weight: bold; }
        .danger-btn { background: transparent; color: #444; font-size: 11px; margin-top: 50px; text-decoration: underline; }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="card">
    <h2 id="lvlDisplay">Level 1</h2>
    <div id="alert"></div>
    <div class="stat-group">
        <div class="stat"><span class="val" id="ptsDisplay">0</span>Points</div>
        <div class="stat"><span class="val" id="strkDisplay">0</span>Streak</div>
    </div>
    
    <div id="exerciseList"></div>
    
    <button id="completeBtn">Complete Level</button>
    <button id="addBtn">+ Add Exercise</button>

    <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 15px;">
        <button class="sync-btn" id="exportBtn">Backup Code (Export)</button>
        <button class="sync-btn" id="importBtn">Restore Code (Import)</button>
        <button class="danger-btn" id="resetBtn">Reset Everything</button>
    </div>
</div>

<script>
    let state = { level: 1, points: 0, streak: 0, lastDate: new Date().toISOString(), exercises: {} };

    const listEl = document.getElementById('exerciseList');
    const alertEl = document.getElementById('alert');
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];

    function save() {
        localStorage.setItem('gym_rpg_data', JSON.stringify(state));
        render();
    }

    function render() {
        document.getElementById('lvlDisplay').innerText = "Level " + state.level;
        document.getElementById('ptsDisplay').innerText = state.points;
        document.getElementById('strkDisplay').innerText = "ðŸ”¥ " + state.streak;
        listEl.innerHTML = '';
        Object.keys(state.exercises).forEach(key => {
            const isDone = state.exercises[key];
            const div = document.createElement('div');
            div.className = isDone ? 'item done' : 'item';
            div.setAttribute('data-name', key);
            div.innerHTML = '<div class="box"></div>' + key;
            listEl.appendChild(div);
        });
    }

    function checkInactivity() {
        const now = new Date();
        const last = new Date(state.lastDate);
        const diffDays = Math.floor((now - last) / 86400000);

        // Friendly Rules:
        if (diffDays >= 28) { // 4 weeks
            state.level = Math.max(1, state.level - 1);
            resetCheckboxes();
            showAlert("4 Weeks Inactive: Level Down");
        } else if (diffDays >= 10) { // 10 days grace for cycle
            resetCheckboxes();
            showAlert("10 Days Inactive: Progress Reset");
        }
        
        // Streak Grace: Only resets if gap is > 3 days
        if (diffDays > 3) {
            state.streak = 0;
        }
        
        // Only update date if they actually did something or if we're initializing
        // We'll update state.lastDate inside the Complete/Save actions instead
    }

    function showAlert(msg) {
        alertEl.innerText = msg;
        alertEl.style.display = "block";
    }

    function resetCheckboxes() { 
        Object.keys(state.exercises).forEach(k => { state.exercises[k] = false; }); 
    }

    // --- CONFETTI ENGINE ---
    function celebrate() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        for (let i = 0; i < 100; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                r: Math.random() * 6 + 4,
                d: Math.random() * 10,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                tilt: Math.random() * 10 - 10
            });
        }
        requestAnimationFrame(drawConfetti);
    }

    function drawConfetti() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p, i) => {
            p.y += Math.cos(p.d) + 3 + p.r / 2;
            p.tilt = Math.sin(p.d) * 15;
            ctx.beginPath();
            ctx.lineWidth = p.r;
            ctx.strokeStyle = p.color;
            ctx.moveTo(p.x + p.tilt + p.r / 2, p.y);
            ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 2);
            ctx.stroke();
            if (p.y > canvas.height) particles[i] = { ...p, y: -20, x: Math.random() * canvas.width };
        });
        if (particles.length > 0) requestAnimationFrame(drawConfetti);
        setTimeout(() => { particles = []; ctx.clearRect(0,0,canvas.width,canvas.height); }, 5000);
    }

    // --- BUTTON ACTIONS ---
    document.getElementById('addBtn').addEventListener('click', () => {
        const n = prompt("Exercise name:");
        if (n && n.trim()) { state.exercises[n.trim()] = false; save(); }
    });

    document.getElementById('completeBtn').addEventListener('click', () => {
        const keys = Object.keys(state.exercises);
        if (keys.length === 0) return;
        
        state.lastDate = new Date().toISOString(); // Update "Last Seen" on action
        
        if (keys.every(k => state.exercises[k])) {
            state.level++; state.points += 100; state.streak++;
            resetCheckboxes();
            celebrate();
            alert("ðŸŽ‰ LEVEL UP!");
        } else {
            state.points += 5;
            alert("Progress Saved! Finish all to Level Up.");
        }
        save();
    });

    listEl.addEventListener('click', (e) => {
        const target = e.target.closest('.item');
        if (target) {
            const name = target.getAttribute('data-name');
            state.exercises[name] = !state.exercises[name];
            save();
        }
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
        prompt("COPY BACKUP CODE:", btoa(unescape(encodeURIComponent(JSON.stringify(state)))));
    });

    document.getElementById('importBtn').addEventListener('click', () => {
        const code = prompt("PASTE BACKUP CODE:");
        if (code) {
            try { state = JSON.parse(decodeURIComponent(escape(atob(code)))); save(); alert("Data Restored!"); }
            catch (e) { alert("Invalid code."); }
        }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        if (confirm("Delete everything?") && confirm("Final Warning?")) {
            localStorage.removeItem('gym_rpg_data');
            location.reload();
        }
    });

    window.onload = () => {
        const saved = localStorage.getItem('gym_rpg_data');
        if (saved) { 
            state = JSON.parse(saved); 
            checkInactivity(); 
        } else {
            const r = prompt("Initial Exercises (comma separated):", "Pushups, Squats");
            if (r) r.split(',').forEach(i => { if(i.trim()) state.exercises[i.trim()] = false; });
            save();
        }
        render();
    };
</script>
</body>
</html>
